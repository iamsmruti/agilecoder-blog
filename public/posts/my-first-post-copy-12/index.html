<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understanding Node.js: Architecture and Internal Workings</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header class="header">
  <h1>
    <a class="logo" href="/">
      <img src="/assets/agilecoder-icon.png"/>
      <p>Agile Coder</p>
    </a>
  </h1>
  <nav >
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/NodeJS/">NodeJS</a></li>
      <li><a href="/ReactJS/">ReactJS</a></li>
    </ul>
  </nav>
</header>


    <article class="blog-page">
        <div>
            <span class="category">NodeJS</span>
            <h2 class="blog-title">Understanding Node.js: Architecture and Internal Workings</h2>
            <p class="blog-published-date"><small>Published on March 4, 2025</small></p>
            <p class="blog-summary">Node.js enables efficient server apps in JavaScript, using a non-blocking, event-driven model. With Googleâ€™s V8 engine and Libuv, it excels at handling asynchronous I/O, ideal for real-time, scalable applications. This article dives into its architecture and internal mechanics.</p>
            <div class="header-image-container">
                <img class="header-image" src="/assets/thumbnail.png" />
            </div>
            <div class="blog-content"><p>AWS S3 (Simple Storage Service) is a popular choice for securely storing files in the cloud. However, in many scenarios, you might want to grant temporary access to files in your S3 bucket without exposing them publicly. For this, AWS offers a powerful feature called pre-signed URLs. In this guide, we&rsquo;ll learn how to use pre-signed URLs to securely share files stored in S3 using Node.js.</p>
<p>If you&rsquo;re new to uploading files to S3, you might want to start with my previous blog post on setting up file uploads to S3 using Node.js and Express. This post will build on that foundation, adding secure, temporary access to those files via pre-signed URLs.</p>
<h2 id="what-are-aws-s3-pre-signed-urls">What Are AWS S3 Pre-Signed URLs?</h2>
<p>A pre-signed URL is a temporary, unique URL that grants time-limited access to a specific file in an S3 bucket. Pre-signed URLs are ideal for cases where you need to share a file temporarily or restrict access without exposing the entire bucket to the public.</p>
<p>Pre-signed URLs are generated by the server and can be set to expire within a specified time, such as 60 seconds, 10 minutes, or several hours. The URL allows authorized access to the object for anyone with the link until it expires.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>To follow along, make sure you have:</p>
<ul>
<li>Node.js and npm installed</li>
<li>An AWS S3 bucket and AWS credentials set up with the necessary permissions</li>
<li>Basic knowledge of Express and file uploads with AWS S3</li>
</ul>
<h2 id="step-1-set-up-the-s3-client">Step 1: Set Up the S3 Client</h2>
<p>To work with S3, we&rsquo;ll use AWS SDK&rsquo;s S3Client and set up our connection parameters. Create a <code>s3Client.js</code> file to initialize the S3 client:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">S3Client</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;@aws-sdk/client-s3&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">dotenv</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;dotenv&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dotenv</span>.<span style="color:#a6e22e">config</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">s3</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">S3Client</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">region</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">AWS_REGION</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">credentials</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">accessKeyId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">AWS_ACCESS_KEY_ID</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">secretAccessKey</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">AWS_SECRET_ACCESS_KEY</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><h2 id="step-2-set-up-file-upload-handling-with-multer">Step 2: Set Up File Upload Handling with Multer</h2>
<p>In order to upload and manage files in memory, we use multer, a Node.js middleware. Here&rsquo;s a quick setup for using multer with memory storage:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">multer</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;multer&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">storage</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">multer</span>.<span style="color:#a6e22e">memoryStorage</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">upload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">multer</span>({ <span style="color:#a6e22e">storage</span> });
</span></span></code></pre></div><p>Now, files will be stored in memory, allowing us to upload them directly to S3 or generate pre-signed URLs without saving them on the server.</p>
<h2 id="step-3-generate-a-pre-signed-url-for-secure-file-access">Step 3: Generate a Pre-Signed URL for Secure File Access</h2>
<p>Our main focus is generating a pre-signed URL to allow secure, temporary access to a file stored in S3. Let&rsquo;s create a controller function that generates a pre-signed URL for an uploaded file.</p>
<p>Here&rsquo;s how the <code>getPresignedAttachmentUrl</code> function works:</p>
<ol>
<li>We fetch the attachment details from our database based on <code>attachmentId</code> provided in the request.</li>
<li>We verify if the requesting user has access to the file.</li>
<li>We extract the file key from the S3 URL and use the <code>getSignedUrl</code> function to generate a secure, time-limited URL.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">GetObjectCommand</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;@aws-sdk/client-s3&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">s3</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;../s3Client.js&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">getSignedUrl</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;@aws-sdk/s3-request-presigner&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">AttachmentModel</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;./model&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">SharingModel</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;../shared_items/model&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">NoteModel</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;../notes/model&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getPresignedAttachmentUrl</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">attachmentId</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">params</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">userId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">userId</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">attachment</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">AttachmentModel</span>.<span style="color:#a6e22e">findById</span>(<span style="color:#a6e22e">attachmentId</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">attachment</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">404</span>).<span style="color:#a6e22e">json</span>({ <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Attachment not found&#34;</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check if user has access to the attachment
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">note</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">NoteModel</span>.<span style="color:#a6e22e">findOne</span>({ <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userId</span>, <span style="color:#a6e22e">attachments</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">attachmentId</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sharingRecord</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">SharingModel</span>.<span style="color:#a6e22e">findOne</span>({ <span style="color:#a6e22e">sharedWithIds</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userId</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">note</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">sharingRecord</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">403</span>).<span style="color:#a6e22e">json</span>({ <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Access denied&#34;</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Extract file key from S3 URL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileKey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">attachment</span>.<span style="color:#a6e22e">s3Url</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;.com/&#34;</span>)[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Generate pre-signed URL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">command</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">GetObjectCommand</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Bucket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">AWS_BUCKET_NAME</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">fileKey</span>,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">signedUrl</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">getSignedUrl</span>(<span style="color:#a6e22e">s3</span>, <span style="color:#a6e22e">command</span>, { <span style="color:#a6e22e">expiresIn</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">60</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">200</span>).<span style="color:#a6e22e">json</span>({ <span style="color:#a6e22e">fileUrl</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">signedUrl</span> });
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Error generating pre-signed URL:&#34;</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">500</span>).<span style="color:#a6e22e">json</span>({ <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Error generating pre-signed URL&#34;</span>, <span style="color:#a6e22e">error</span> });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h3 id="explanation-of-the-code">Explanation of the Code</h3>
<ul>
<li><strong>Attachment Verification</strong>: We first check if the file exists in our database. If not, a 404 Not Found error is returned.</li>
<li><strong>Access Control</strong>: We verify if the requesting user is allowed access to the file by checking permissions in <code>NoteModel</code> and <code>SharingModel</code>.</li>
<li><strong>Generating the Pre-Signed URL</strong>:
<ul>
<li>We create a <code>GetObjectCommand</code> using the S3 bucket name and file key.</li>
<li>Using <code>getSignedUrl</code>, we create a pre-signed URL with a 60-second expiration.</li>
</ul>
</li>
<li><strong>Sending the Pre-Signed URL</strong>: If the URL is successfully generated, it is returned in the response, allowing the user to download the file securely for the next 60 seconds.</li>
</ul>
<h2 id="step-4-setting-up-the-express-route">Step 4: Setting Up the Express Route</h2>
<p>Next, let&rsquo;s set up an Express route to handle requests for pre-signed URLs. In your main server file (<code>index.js</code>), create the route, and link it to the <code>getPresignedAttachmentUrl</code> controller.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">express</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;express&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">getPresignedAttachmentUrl</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;./controllers/presignedUrlController.js&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">express</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">PORT</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">PORT</span> <span style="color:#f92672">||</span> <span style="color:#ae81ff">3000</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Route to get a pre-signed URL for file access
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;/attachments/:attachmentId/url&#34;</span>, <span style="color:#a6e22e">getPresignedAttachmentUrl</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#a6e22e">PORT</span>, () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Server running on port </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">PORT</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><h2 id="testing-the-pre-signed-url-endpoint">Testing the Pre-Signed URL Endpoint</h2>
<p>To test this endpoint:</p>
<ol>
<li>Start the server: <code>node index.js</code></li>
<li>Send a GET request to <code>http://localhost:3000/attachments/{attachmentId}/url</code> with a valid <code>attachmentId</code></li>
<li>You should receive a JSON response containing a <code>fileUrl</code>, which is the pre-signed URL for accessing the file</li>
</ol>
<p>If the URL is successfully generated, you&rsquo;ll receive a response like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;fileUrl&#34;</span>: <span style="color:#e6db74">&#34;https://your-bucket.s3.your-region.amazonaws.com/your-file-key?X-Amz-Expires=60&amp;X-Amz-Signature=abc123...&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Clicking or navigating to this <code>fileUrl</code> in a browser will allow access to the file for 60 seconds.</p>
<h2 id="benefits-of-using-s3-pre-signed-urls">Benefits of Using S3 Pre-Signed URLs</h2>
<ul>
<li><strong>Security</strong>: Pre-signed URLs allow you to grant time-limited access to files without exposing the entire bucket.</li>
<li><strong>Flexibility</strong>: You can control the expiration time and permissions, enabling you to create custom file-sharing options.</li>
<li><strong>Reduced Bandwidth Costs</strong>: Since files are accessed directly from S3, you don&rsquo;t need to proxy the file through your server.</li>
</ul>
<h2 id="key-considerations-for-pre-signed-urls">Key Considerations for Pre-Signed URLs</h2>
<ul>
<li><strong>Expiration Time</strong>: Choose an expiration time that balances security with user experience.</li>
<li><strong>Access Control</strong>: Make sure only authorized users can generate pre-signed URLs.</li>
<li><strong>Permissions</strong>: Pre-signed URLs can be generated for uploading, downloading, or other S3 operations, so set appropriate permissions based on your use case.</li>
</ul>
<p>Pre-signed URLs are a powerful feature for securely sharing files from AWS S3. By generating URLs that expire after a certain time, you can grant temporary access to your files while keeping your S3 bucket private.</p>
<p>With both uploading and secure access in place, your application can handle file management efficiently and securely.</p>
<p>That&rsquo;s it for this article! See ya ðŸ‘‹</p>
</div>
        </div>
    </article>
</body>
</html>
